<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Ska Radios</title>
  <link rel="stylesheet" href="styles.css">
  <title>Ska Radios</title>
  <script type="text/javascript">

    // ---------------------------
    // Show data
    // ---------------------------
    const weeklySchedule = {
      0: [ // Sunday
        {
          name: "Blue Beat in my Soul",
          id: "bbims",
          recurrence: "2nd, 4th",
          showUrl: "https://radioflora.de/shows/blue-beat-in-my-soul-ska-rocksteady-reggae-soul-from-the-60s-to-today/",
          station: "Radio Flora",
          stationUrl: "https://radioflora.de",
          stationTown: "Hannover",
          start_h: 20,
          start_m: 0,
          end_h: 22,
          end_m: 0,
          streamUrl: "https://radioflora.de",
          archiveUrl: "https://www.mixcloud.com/bluebeatshelter/",
          timezone: 1
        },
        {
          name: "Rudie’s back in town",
          id: "rbit",
          recurrence: "fortnightly (?)",
          showUrl: "https://rudies-back-in-town.blogspot.com/",
          station: "Radio libertaire",
          stationUrl: "https://radio-libertaire.org/agenda/",
          stationTown: "Paris",
          start_h: 22,
          start_m: 0,
          end_h: 0,
          end_m: 0,
          streamUrl: "http://media.radio-libertaire.org:8080/radiolib.mp3",
          archiveUrl: "https://radio-libertaire.org/agenda/passechx.php",
          timezone: 1
        }
      ],
      1: [ // Monday
        {
          name: "Ska Patrol",
          id: "sp",
          recurrence: "weekly",
          showUrl: "https://skapatrol.weebly.com",
          station: "NEAR fm 90.3",
          stationUrl: "https://nearfm.ie/",
          stationTown: "Dublin",
          start_h: 20,
          start_m: 0,
          end_h: 22,
          end_m: 0,
          streamUrl: "https://nearfm.ie/livestream/",
          archiveUrl: "",
          timezone: 0
        }
      ],
      2: [ // Tuesday
        {
          name: "Rock Steady Rhythms",
          id: "rsr",
          recurrence: "weekly",
          showUrl: "https://www.dundalkfm.com/category/music/",
          station: "Dundalk FM",
          stationUrl: "https://www.dundalkfm.com/",
          stationTown: "Dundalk",
          start_h: 19,
          start_m: 0,
          end_h: 21,
          end_m: 0,
          streamUrl: "https://www.dundalkfm.com/",
          archiveUrl: "https://www.dundalkfm.com/listen-again/",
          timezone: 0
        }
      ],
      3: [ // Wednesday
        {
          name: "Rudeboy's Delight",
          id: "rd",
          recurrence: "weekly",
          showUrl: "https://www.wueste-welle.de/sendung/view/id/81/Rudeboy-rsquo-s_Delight.html",
          station: "Wüste Welle",
          stationUrl: "https://www.wueste-welle.de",
          stationTown: "Tübingen",
          start_h: 22,
          start_m: 0,
          end_h: 23,
          end_m: 0,
          streamUrl: "https://www.wueste-welle.de/broadcasts/livestream/",
          archiveUrl: "https://www.wueste-welle.de/mediathek/viewsendung/id/78445",
          timezone: 1
        },
        {
          name: "Offbeat",
          id: "o",
          recurrence: "weekly",
          showUrl: "https://www.facebook.com/RiverinaRudeboy",
          station: "Triple AAA FM",
          stationUrl: "https://tripleafm.net.au",
          stationTown: "Wagga Wagga",
          start_h: 20,
          start_m: 0,
          end_h: 22,
          end_m: 0,
          streamUrl: "https://tripleafm.net.au/stream",
          timezone: 10
        }
      ],
      4: [], // Thursday    
      5: [ // Friday
        {
          name: "File Under Ska",
          id: "fus",
          recurrence: "monthly",
          showUrl: "https://www.file-under-ska.de",
          station: "FRS",
          stationUrl: "https://www.freies-radio.de",
          stationTown: "Stuttgart",
          start_h: 20,
          start_m: 0,
          end_h: 22,
          end_m: 0,
          streamUrl: "https://streaming.fueralle.org/frs-hi.mp3",
          archiveUrl: "https://www.freies-radio.de/mediathek",
          timezone: 1
        }
      ],
      6: [ // Saturday
        {
          name: "SkaTime FS-Ska",
          id: "st",
          recurrence: "monthly",
          station: "FSK Hamburg",
          stationUrl: "https://www.fsk-hh.org",
          stationTown: "Hamburg",
          start_h: 18,
          start_m: 0,
          end_h: 19,
          end_m: 30,
          streamUrl: "https://streaming.fueralle.org/fsk.mp3",
          archiveUrl: "https://www.fsk-hh.org/archive",
          timezone: 1
        }
      ],
    };

/*
Timezones

Abbreviation  GMT Offset IANA Time Zone (City)
HST           UTC−10     Pacific/Honolulu
AKST          UTC−9      America/Anchorage
AKDT          UTC−8      America/Anchorage
PST           UTC−8      America/Los_Angeles
PDT           UTC−7      America/Los_Angeles
MST           UTC−7      America/Denver
MDT           UTC−6      America/Denver
CST           UTC−6      America/Chicago
CDT           UTC−5      America/Chicago
EST           UTC−5      America/New_York
EDT           UTC−4      America/New_York
AST           UTC−4      America/Halifax
NST           UTC−3:30   America/St_Johns
GMT           UTC+0      Europe/London
UTC           UTC+0      UTC
CET           UTC+1      Europe/Paris
CEST          UTC+2      Europe/Paris
EET           UTC+2      Europe/Helsinki
EEST          UTC+3      Europe/Helsinki
MSK           UTC+3      Europe/Moscow
PKT           UTC+5      Asia/Karachi
IST           UTC+5:30   Asia/Kolkata
AWST          UTC+8      Australia/Perth
JST           UTC+9      Asia/Tokyo
KST           UTC+9      Asia/Seoul
ACST          UTC+9:30   Australia/Adelaide
AEST          UTC+10     Australia/Sydney
ACST (DST)    UTC+10:30  Australia/Adelaide
AEDT          UTC+11     Australia/Sydney
NZST          UTC+12     Pacific/Auckland
NZDT          UTC+13     Pacific/Auckland
*/

    const weekdays = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];
    const months = ["January","February","March","April","May","June","July","August","September","October","November","December"];

    const localTimeZoneFormatter = new Intl.DateTimeFormat("en-GB", {
      timeZoneName: "short"
    });

    let timeZoneElements;

    // target timezones
    const targetZones = [
      { name: "PST", offset: -8 },
      { name: "EST", offset: -5 },
      { name: "GMT", offset: 0 },
      { name: "CET", offset: 1 },
      { name: "MSK", offset: 3 },
      { name: "JST", offset: 9 },
      { name: "AEST", offset: 10 }
    ];

    function updateTimes() {
      const now = new Date();
      // update local time on top
      document.getElementById("now").innerHTML = formatDate(now.getDay(), now.getDate(), now.getMonth(), now.getFullYear(), now.getHours(), now.getMinutes(), now.getSeconds()) + formatWeekInMonth(formatOrdinal(getWeekOfMonth(now.getDate())), now.getDay());
      // update UTC time on top
      document.getElementById("utc").innerHTML = formatDate(now.getUTCDay(), now.getUTCDate(), now.getUTCMonth(), now.getUTCFullYear(), now.getUTCHours(), now.getUTCMinutes(), now.getUTCSeconds()) + formatWeekInMonth(formatOrdinal(getWeekOfMonth(now.getUTCDate())), now.getUTCDay());
      document.getElementById("timezone").innerHTML = localTimeZoneFormatter.formatToParts(now).find(p => p.type === "timeZoneName").value;
      document.getElementById("gmtOffsetMessage").innerHTML = getGMTOffsetMessage();  
      // update timezone times
      timeZoneElements.pst.textContent = formatInTimeZone(now, "America/Los_Angeles");
      timeZoneElements.est.textContent = formatInTimeZone(now, "America/Jamaica");
      timeZoneElements.gmt.textContent = formatInTimeZone(now, "Europe/London");
      timeZoneElements.cet.textContent = formatInTimeZone(now, "Europe/Berlin");
      timeZoneElements.msk.textContent = formatInTimeZone(now, "Europe/Moscow");
      timeZoneElements.jst.textContent = formatInTimeZone(now, "Asia/Tokyo");
      timeZoneElements.aest.textContent = formatInTimeZone(now, "Australia/Sydney");

      for (let day = 0; day <= 6; day++) {
        weeklySchedule[day].forEach(show => {
          const idElement = document.getElementById(show.id + "_countdown");
          if (isShowNowOn(show, day)) {
            idElement.innerHTML = "NOW PLAYING!";
            idElement.classList.add("blink-red");
          } else {
            const nextStartDate = getNextStartDate(show, day);
            const remaining_sec = Math.ceil((nextStartDate - now) / 1000);
            idElement.innerHTML = formatDuration(remaining_sec);
          }
        });
      }
    }

    function formatDate(day, date, month, year, hour, minute, second) {
      let text = weekdays[day] + ', ' + date + '. ' + months[month] + ' ' + year + ', ';
      if (hour < 10) { text += "0"; }
      text += '<span class="bold">' + hour + ':'
      if (minute < 10) { text += "0"; }
      text += minute + ':'
      if (second < 10) { text += "0"; }
      return text + second + '</span>';
    }

    function getWeekOfMonth(day) {
      if (day < 8) return 1;
      if (day < 15) return 2;
      if (day < 22) return 3;
      if (day < 29) return 4;
      return 5;
    }

    function formatOrdinal(number) {
      if (number === 1) return "1<sup>st</sup>";
      if (number === 2) return "2<sup>nd</sup>";
      if (number === 3) return "3<sup>rd</sup>";
      return number + "<sup>th</sup>";
    }

    function formatWeekInMonth(weekInMonth, day) {
      return '<span class="small-text"> (' + weekInMonth + ' ' + weekdays[day] + ' this month)</span>';
    }

    function getGMTOffsetMessage() {
      const offsetMinutes = new Date().getTimezoneOffset();
      if (offsetMinutes === 0) {
        return "You are in GMT.";
      }
      const offsetHours = Math.abs(offsetMinutes) / 60;
      const hourLabel = offsetHours === 1 ? "hour" : "hours";
      const direction = offsetMinutes > 0 ? "behind" : "ahead of";

      return `You are ${offsetHours} ${hourLabel} ${direction} GMT.`;
    }

    window.addEventListener("DOMContentLoaded", () => {

      timeZoneElements = {
        pst: document.getElementById("pst"),
        est: document.getElementById("est"),
        gmt: document.getElementById("gmt"),
        cet: document.getElementById("cet"),
        msk: document.getElementById("msk"),
        jst: document.getElementById("jst"),
        aest: document.getElementById("aest")
      };

      renderTable();
      updateTimes();
      setInterval(renderTable, 300_000);
      setInterval(updateTimes, 1000);
    });
  </script>
</head>

<body>
<h1>Ska Radios of the world, unite!</h1>
<!-- No warranty, there may be minor errors... -->
The Facebook Group: <a target="_parent" href="https://www.facebook.com/groups/444399576124393/">Ska podcasts & radio shows</a>
<br/>
<table>
  <tr>
    <td>Your local time (<span id="timezone"></span>):</td><td><span id="now"></span></td>
  </tr>
  <tr>
    <td><a target="_parent" href="https://en.wikipedia.org/wiki/Coordinated_Universal_Time">UTC (GMT)</a>:</td><td><span id="utc"></span></td>
  </tr>
  <tr>
    <td colspan="2"><span id="gmtOffsetMessage"></span></td>
  </tr>
</table>
<br/>
<h2>FM Radio Shows</h2>

<table id="radioTable">
  <thead>
  <tr>
    <th>Day</th>
    <th>Recurrence</th>
    <th>Show</th>
    <th>Station</th>
    <th>Stream</th>
    <th>Archive</th>
    <th>Time until next show</th>
    <th class="center nowrap">Vancouver<br/>Los Angeles<br/><span class="small-text">PST (UTC-8)</span><br/><span id="pst"></span></th>
    <th class="center nowrap">New York<br/>Kingston<br/><span class="small-text">EST (UTC-5)</span><br/><span id="est"></span></th>
    <th class="center nowrap">London<br/>Dublin<br/><span class="small-text">GMT (UTC)</span><br/><span id="gmt"></span></th>
    <th class="center nowrap">Stuttgart<br/>Skaska<br/><span class="small-text">CET (UTC+1)</span><br/><span id="cet"></span></th>
    <th class="center nowrap">St. Petersburg<br/>Москва<br/><span class="small-text">MSK (UTC+3)</span><br/><span id="msk"></span></th>
    <th class="center nowrap">Tokyo<br/>Perth<br/><span class="small-text">JST (UTC+9)</span><br/><span id="jst"></span></th>
    <th class="center nowrap">Melbourne<br/>Sydney<br/><span class="small-text">AEST (UTC+10)</span><br/><span id="aest"></span></th>
  </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
  // --------------------------
  // Helper functions
  // --------------------------
  function makeUTCDate(hours, minutes) {
    const date = new Date();
    date.setUTCHours(hours, minutes, 0, 0);
    return date;
  }

  function getNextStartDate(show, weekday) {
    const now = new Date();
    const next = makeUTCDate(show.start_h - show.timezone, show.start_m);
    const diff = (weekday - next.getUTCDay() + 7) % 7;
    next.setUTCDate(next.getUTCDate() + diff);

    if (next <= now) {
      next.setUTCDate(next.getUTCDate() + 7);
    }

    return next;
  }

  function getShowTimeInZone(show, showDay, zone) {
    const offset = zone.offset - show.timezone;
    const start = show.start_h + offset;
    const end = show.end_h + offset;

    const dayShift = Math.floor(start / 24);
    const start_h = ((start % 24) + 24) % 24;
    const end_h = ((end % 24) + 24) % 24;

    const day = (showDay + dayShift + 7) % 7;

    return {
      start_h: start_h,
      start_m: show.start_m,
      end_h: end_h,
      end_m: show.end_m,
      day: day
    }
  }

  function formatDuration(sec) {
    const days = Math.floor(sec / 86_400);
    const hours = Math.floor(sec / 3600) % 24;
    const minutes = Math.floor(sec / 60) % 60;
    const seconds = sec % 60;
    return `${days ? days + " d, " : ""}${hours ? hours + " h, " : ""}${minutes} m, ${seconds} s`;
  }

  function isShowNowOn(show, weekday) {
    const now = new Date();
    const showStart = makeUTCDate(show.start_h - show.timezone, show.start_m);
    const diff = (weekday - showStart.getUTCDay() + 7) % 7;
    showStart.setUTCDate(showStart.getUTCDate() + diff);
    const showEnd = makeUTCDate(show.end_h - show.timezone, show.end_m);
    showEnd.setUTCDate(showEnd.getUTCDate() + diff);
    return showStart <= now && now <= showEnd;
  }

  function formatInTimeZone(date, timeZone) {
    return new Intl.DateTimeFormat("en-GB", {
      timeZone: timeZone,
      hour: "2-digit",
      minute: "2-digit",
      second: "2-digit",
      hour12: false
    }).format(date);
  }

  function addTd(tr, text, url, fallback, lineBelow) {
    const td = document.createElement("td");
    if (url) {
      const link = document.createElement("a");
      link.href = url;
      link.textContent = text;
      link.target = "_blank";
      link.rel = "noopener noreferrer";
      td.appendChild(link);
    } else {
      td.textContent = fallback ?? text;
    }
    if (lineBelow) {
      td.appendChild(document.createElement("br"));
      td.appendChild(document.createTextNode(lineBelow));
    }
    tr.appendChild(td);
  }

  // ---------------------------
  // Create the table
  // ---------------------------
  function renderTable() {
    const now = new Date();

    const tbody = document.querySelector("#radioTable tbody");
    tbody.innerHTML = "";

    for (let day = 0; day <= 6; day++) {
      weeklySchedule[day].forEach(show => {
      const tr = document.createElement("tr");

      // Day
      addTd(tr, weekdays[day]);

      // Recurrence
      addTd(tr, show.recurrence);

      // Show
      addTd(tr, show.name, show.showUrl);

      // Station
      addTd(tr, show.station, show.stationUrl, "", show.stationTown);

      // Stream
      addTd(tr, "Stream", show.streamUrl, "-");

      // Archive
      addTd(tr, "Archive", show.archiveUrl, "-");

      // Time until next show, or is the show on playing?
      const waitOrPlayingTd = document.createElement("td");
      const span = document.createElement("span");
      span.id = show.id + "_countdown";
      waitOrPlayingTd.appendChild(span);
      waitOrPlayingTd.classList.add("nowrap-right");
      tr.appendChild(waitOrPlayingTd);

      // traverse timezones
      targetZones.forEach(zone => {
        const td = document.createElement("td");
        const showTimeInZone = getShowTimeInZone(show, day, zone);

        let startTime = showTimeInZone.start_h + ":" + showTimeInZone.start_m;
        if (showTimeInZone.start_h < 10) startTime = "0" + startTime;
        if (showTimeInZone.start_m === 0) startTime += "0";

        let endTime = showTimeInZone.end_h + ":" + showTimeInZone.end_m;
        if (showTimeInZone.end_h < 10) endTime = "0" + endTime;
        if (showTimeInZone.end_m === 0) endTime += "0";
        
        td.innerHTML = startTime + " - " + endTime;
        if (day != showTimeInZone.day) {
          td.innerHTML += '<br/><span class="small-text">' + weekdays[showTimeInZone.day] + "</span>";
        }
        if (zone.offset === show.timezone) {
          td.classList.add("bold");
        }
        td.classList.add("center-top", "nowrap");
        tr.appendChild(td);
      });

      tbody.appendChild(tr);
      });
    }
  }
</script>


<!-- gone: www.upsettingstation.tk -->
<p>
<h2>24/7 Streams</h2>
<table>
  <tbody>
  <tr>
    <th class="header">Programme</th>
    <th class="header">Stream</th>
    <th class="header">Facebook</th>
  </tr>
  <tr>
    <td class="top"><a target="_parent" href="https://www.skaparade.com">Ska Parade</a></td>
    <td class="top"><a target="_parent" href="https://www.skaparade.com/play.pls">Stream</a></td>
    <td class="top"><a target="_parent" href="https://www.facebook.com/people/Ska-Parade/100068801391638/">Facebook</a></td>
  </tr>
  <tr>
    <td class="top"><a target="_parent" href="https://www.buttondownradio.com">Button Down Radio</a></td>
    <td class="top"><a target="_parent" href="https://www.buttondownradio.com">Stream</a></td>
    <td class="top"><a target="_parent" href="https://www.facebook.com/buttondownradio5446">Facebook</a></td>
  </tr>
  </tbody>
</table>
<p>
  <!--
      24/7: Easy Skanking <a target="_parent" href="https://www.easyskanking.tk/">Homepage</a> <a target="_parent" href="https://64.20.36.156:8003/listen.pls">Stream (Winamp)</a><br/>
  -->
<p>
<h2>Podcasts</h2>
<table>
  <tbody>
  <tr>
    <th class="header">Programme</th>
    <th class="header">Homepage</th>
    <th class="header">Facebook</th>
    <th class="header">Spotify</th>
  </tr>
  <tr>
    <td class="top">Hornpod: A Ska Podcast</td>
    <td class="top"><a target="_parent" href="https://www.hornpod.org">hornpod.org</a></td>
    <td class="top"><a target="_parent" href="https://www.facebook.com/hornpod">facebook.com/hornpod</a></td>
    <td class="top"><a target="_parent" href="https://www.spotify.com/hornpod/">Check</a></td>
  </tr>
  <tr>
    <td class="top">Ska Nation Radio with Beefy</td>
    <td class="top"><a target="_parent" href="https://www.iheart.com/podcast/269-beefys-ska-club-73944291/">iheart.com/podcast/269-beefys-ska-club-73944291/</a></td>
    <td class="top"><a target="_parent" href="https://www.facebook.com/BeefySkaClub">Facebook</a></td>
    <td class="top"><a target="_parent" href="https://www.spotify.com/skanation/">Check</a></td>
  </tr>
  </tbody>
</table>
<p>
<h2>Other</h2>
<ul>
  <li>Blue Beat & Ska <a target="_parent" href="https://www.mixcloud.com/bluebeatandska/">Mixcloud</a>, <a target="_parent" href="https://www.facebook.com/bluebeatandska">Facebook</a></li>
  <li>Offbeat, 2 hours of Ska, Rocksteady and Reggae <a target="_parent" href="https://www.facebook.com/RiverinaRudeboy">Facebook</a>
  <!--7pm on 96.7 2GHR in the Greater Hume and Albury Wodonga
      8pm on Triple AAA Fm in Wagga, Coolamon, Junee and Gundagai
      And online from those station's websites at those times, or via any good radio app.
   -->
  </li>
</ul>

</body>
</html>